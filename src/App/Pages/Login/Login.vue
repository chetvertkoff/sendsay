<template>
<section class="auth">
  <div class="auth__container">
    <Logo :parentClass="'auth__logo'" />
    <Form 
      :isLoad="isLoad"
      :errMessage="errMessage"
      @submit-auth-form="onSubmitForm"
    />
    <a href="https://github.com/chetvertkoff/sendsay" class="link auth__link">@chetvertkoff</a>
  </div>
</section>
</template>

<script>
  import router from 'vue'
  import Cookies from 'js-cookie'
  import Logo from '@/UI/Logo'
  import Form from './Form'
  import getModel from '@/Models'
  import http from '@/utils/http'

  // Логин: chetvertkoffkirill@gmail.com
  // Пароль: sa9Niqueng

  export default {
    components: {Logo, Form},
    data(){
      return {
        isLoad: false,
        errMessage: ""
      }
    },
    methods: {
      onSubmitForm(formFields) {
        const fields = getModel('AuthFields', formFields);

        Promise.resolve(this.reqLogin(fields))
        .then(res=>{
          if(res.explain){
            const {id, explain} = res;

            this.errMessage = JSON.stringify({id, explain});
            return;
          }
          if(!this.errMessage) this.errMessage = "";
          this.$router.push('/');
        })
      },
      async reqLogin(fields) {
        const {login, sublogin} = fields;
        const userInfo = JSON.stringify({login, sublogin});
        
        this.isLoad = true;
        const res = await http(fields);
        this.isLoad = false;
        if(!res.session) return res;
        Cookies.set('sendsay_session', res.session, { expires: 7 });
        localStorage.setItem('user_info', userInfo);
        
        return res;
      }
    }
  }
</script>